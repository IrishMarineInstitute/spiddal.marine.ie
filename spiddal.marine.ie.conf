# You may add here your
# server {
#    ...
# }
# statements for each of your virtual hosts to this file

##
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# http://wiki.nginx.org/Pitfalls
# http://wiki.nginx.org/QuickStart
# http://wiki.nginx.org/Configuration
#
# Generally, you will want to move this file somewhere, and start with a clean
# file but keep this around for reference. Or just disable in sites-enabled.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# NB: We do not do caching here, but will do so at the frontend server.
lua_package_path '/home/dmuser/sites/spiddal.marine.ie/lua/?.lua;;';
server {
    listen 8001 default_server;
    listen [::]:8001 default_server ipv6only=on;

    root /home/dmuser/sites/spiddal.marine.ie/html;
    index index.html index.htm;

    # Make site accessible from http://localhost/
    server_name spiddal.marine.ie;

    location /spidvid/hls/ {
            proxy_pass http://172.16.255.19/hls/;
    }

    location /spidvid/dash/ {
            proxy_pass http://172.16.255.19/dash/;
    }

    location / {
        if ($arg_SERVICE = SOS){
                   rewrite ^ /service/SOS?ACCEPTVERSIONS=$arg_ACCEPTVERSIONS&OFFERING=$arg_OFFERING&REQUEST=$arg_REQUEST;
        }
        # First attempt to serve request as file, then
        # as directory, then fall back to displaying a 404.
        try_files $uri $uri/ =404;
        # Uncomment to enable naxsi on this location
        # include /etc/nginx/naxsi.rules
    }
    location /data/ {
        root /;
        autoindex on;
        add_header 'Access-Control-Allow-Origin' '*';
    try_files $uri $uri/ =404;
    }


    location /service/SOS {
        if ($arg_ACCEPTVERSIONS = 1.0.0){
            rewrite ^ /service/SOS/acceptversions/v1d0d0?REQUEST=$arg_REQUEST&OFFERING=$arg_OFFERING;
        }
    }
    
    location /service/SOS/acceptversions/v1d0d0 {
        if ($arg_REQUEST = GetCapabilities){
            rewrite ^ /service/SOS/acceptversions/v1d0d0/request/getcapabilities;
        }
        if ($arg_REQUEST = GetObservation){
            rewrite ^ /service/SOS/acceptversions/v1d0d0/request/getobservation/offering/$arg_OFFERING;
        }
        if ($arg_REQUEST = DescribeSensor){
            rewrite ^ /service/SOS/acceptversions/v1d0d0/request/describesensor/procedure/$arg_PROCEDURE;
        }
    }

    location /service/SOS/acceptversions/v1d0d0/request/getcapabilities {
        add_header Content-Type text/xml;
        try_files /sensor-observation-service/xml/capabilities.xml =404;
    }
    #
    #    The following location directives deal with processing specific 
    #    GetObservation requests
    #    
    location /service/SOS/acceptversions/v1d0d0/request/getobservation/offering/ie.marine.data:idronaut.oceanseven.304.XXXX {
        if ($arg_EVENTTIME){
            rewrite ^ /service/SOS/timeseries;
        }
        if ($arg_REQUEST = GetObservation){
            rewrite ^ /service/SOS/observation;
        }
    }
        
    location /service/SOS/acceptversions/v1d0d0/request/getobservation/offering/ie.marine.data:instrument:wetlabs.ecoflntu.3137 {
        if ($arg_EVENTTIME){
            rewrite ^ /service/SOS/timeseries;
        }
        if ($arg_REQUEST = GetObservation){
            rewrite ^ /service/SOS/observation;
        }
    }
    
    #
    # DescribeSensor locations
    #
    
    location /service/SOS/acceptversions/v1d0d0/request/describesensor/procedure/ie.marine.data:instrument:teledynerdi-workhorse600-1323 {
        add_header Content-Type text/xml;
        try_files /sensor-observation-service/xml/trdi-wh600-1323.xml =404;
    }
    
    location /service/SOS/acceptversions/v1d0d0/request/describesensor/procedure/ie.marine.data:instrument:idronaut.oceanseven.304 {
        add_header Content-Type text/xml;
        try_files /sensor-observation-service/xml/ioceanseven-304.xml =404;
    }
    
    location /service/SOS/acceptversions/v1d0d0/request/describesensor/procedure/ie.marine.data:instrument:idronaut.oceanseven.304.XXXX {
        add_header Content-Type text/xml;
        try_files /sensor-observation-service/xml/ioceanseven-304-hash-something.xml =404;
    }
    
    location /service/SOS/acceptversions/v1d0d0/request/describesensor/procedure/ie.marine.data:instrument:wetlabs.ecoflntu {
        add_header Content-Type text/xml;
        try_files /sensor-observation-service/xml/wetlabs-ecoflntu.xml =404;
    }
    
    location /service/SOS/acceptversions/v1d0d0/request/describesensor/procedure/ie.marine.data:instrument:wetlabs.ecoflntu.3137 {
        add_header Content-Type text/xml;
        try_files /sensor-observation-service/xml/wetlabs-ecoflntu-3137.xml =404;
    }

    location /service/SOS/timeseries {
        content_by_lua_file "/home/dmuser/sites/spiddal.marine.ie/lua/om_timeseries_handler.lua";
    }
    location /service/SOS/observation {
        content_by_lua_file "/home/dmuser/sites/spiddal.marine.ie/lua/om_observation_handler.lua";
    }
    location ~ ^/ping/.* {
        content_by_lua_file "/home/dmuser/sites/spiddal.marine.ie/lua/ping.lua";
    }

}

